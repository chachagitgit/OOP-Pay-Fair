<!DOCTYPE html>
<html>
<head>
  <title>PayFair</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      padding: 20px;
      background-color: #f5f5f5;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
      font-size: 2em;
    }

    .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: #3498db;
    }

    .discount-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 6px;
    }

    .discount-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    button {
      width: 100%;
      padding: 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #2980b9;
    }

    #map {
      height: 400px;
      width: 100%;
      margin: 20px 0;
      border-radius: 10px;
      border: 1px solid #ddd;
    }

    #fareSummary {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    #fareSummary h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }

    #fareSummary p {
      margin: 10px 0;
      color: #34495e;
      line-height: 1.5;
    }

    .total-fare {
      font-size: 1.2em;
      color: #2c3e50;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px dashed #ddd;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .input-group {
        grid-template-columns: 1fr;
      }
    }

    .pac-container {
      z-index: 1051 !important;
    }

    /* Add new styles for enhanced dropdown */
    .vehicle-select {
      position: relative;
      width: 100%;
    }

    .vehicle-select select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: all 0.3s;
      background-color: white;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 35px;
    }

    .vehicle-select::after {
      content: 'â–¼';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #666;
      font-size: 12px;
      height: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      margin-top: -2px;
    }

    .vehicle-select select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .vehicle-select select optgroup {
      font-weight: bold;
      color: #2c3e50;
      background-color: #f8f9fa;
    }

    .vehicle-select select option {
      padding: 12px;
      background-color: white;
    }

    .vehicle-select select option:disabled {
      background-color: #f5f5f5;
      color: #999;
      font-style: italic;
    }

    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
      margin-left: 8px;
      color: #666;
      cursor: help;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: white;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 14px;
      pointer-events: none;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Vehicle type indicator styles */
    .vehicle-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      background-color: #f8f9fa;
      font-size: 14px;
    }

    .vehicle-indicator.available {
      color: #2ecc71;
      border-left: 4px solid #2ecc71;
    }

    .vehicle-indicator.unavailable {
      color: #e74c3c;
      border-left: 4px solid #e74c3c;
    }

    /* Ensure the select box has consistent height */
    .input-group select {
      height: 45px;
      line-height: 21px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>PayFair</h2>
    
    <div class="input-group">
      <input 
        type="text" 
        id="originInput" 
        placeholder="Enter origin location">

      <input 
        type="text" 
        id="destinationInput" 
        placeholder="Enter destination location">

      <div class="vehicle-select">
        <select id="vehicle">
          <optgroup label="Bus Services">
            <option value="1">Airconditioned Bus</option>
            <option value="2">Ordinary Bus</option>
          </optgroup>
          <optgroup label="Jeepney Services">
            <option value="3">Modern E-Jeepney</option>
            <option value="4">Traditional Jeepney</option>
          </optgroup>
        </select>
        <div id="vehicleInfo" class="vehicle-indicator"></div>
      </div>

      <div class="discount-group">
        <label>
          <input type="checkbox" id="discount">
          <span>Discounted Rate (Student/Senior/PWD)</span>
        </label>
      </div>

      <button onclick="calculateRoute()">Calculate Fare</button>
    </div>

    <div id="map"></div>
    <div id="fareSummary"></div>
  </div>

  <script>
    let map, directionsService, directionsRenderer;
    let originAutocomplete, destinationAutocomplete;

    function initMap() {
      const manila = { lat: 14.5995, lng: 120.9842 };
      
      // Initialize the map
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 11,
        center: manila,
        styles: [
          {
            featureType: "poi",
            elementType: "labels",
            stylers: [{ visibility: "off" }]
          }
        ]
      });

      //initialize directions
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
          strokeColor: "#3498db",
          strokeWeight: 5
        }
      });
      directionsRenderer.setMap(map);

      //autocomplete
      originAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById("originInput"),
        { 
          componentRestrictions: { country: "ph" },
          fields: ["geometry", "name"]
        }
      );

      destinationAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById("destinationInput"),
        { 
          componentRestrictions: { country: "ph" },
          fields: ["geometry", "name"]
        }
      );
    }

    function calculateRoute() {
      const origin = originAutocomplete.getPlace();
      const destination = destinationAutocomplete.getPlace();

      if (!origin || !origin.geometry) {
        alert("Please select a valid origin from the dropdown.");
        return;
      }

      if (!destination || !destination.geometry) {
        alert("Please select a valid destination from the dropdown.");
        return;
      }

      //clear old markers if there are any
      if (window.originMarker) window.originMarker.setMap(null);
      if (window.destMarker) window.destMarker.setMap(null);

      window.originMarker = new google.maps.Marker({
        position: origin.geometry.location,
        map: map,
        title: origin.name,
        icon: {
          url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
          scaledSize: new google.maps.Size(40, 40)
        },
        animation: google.maps.Animation.DROP
      });

      window.destMarker = new google.maps.Marker({
        position: destination.geometry.location,
        map: map,
        title: destination.name,
        icon: {
          url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
          scaledSize: new google.maps.Size(40, 40)
        },
        animation: google.maps.Animation.DROP
      });

      const request = {
        origin: origin.geometry.location,
        destination: destination.geometry.location,
        travelMode: google.maps.TravelMode.DRIVING,
        optimizeWaypoints: true
      };

      directionsService.route(request, function(result, status) {
        if (status === "OK") {
          directionsRenderer.setDirections(result);

          const route = result.routes[0];
          const distanceMeters = route.legs[0].distance.value;
          const distanceKm = distanceMeters / 1000;
          const duration = route.legs[0].duration.text;

          //available transpo modes
          getAvailableTransportModes(route).then(availableModes => {
            //update vehicle dropdown
            updateVehicleOptions(availableModes);

            const vehicleChoice = parseInt(document.getElementById("vehicle").value);
            const isDiscounted = document.getElementById("discount").checked;

            const fareInfo = calculateFare(distanceKm, vehicleChoice, isDiscounted);
            displayFare(distanceKm, fareInfo, duration, availableModes);

            //adjust map zoom level to show route
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(origin.geometry.location);
            bounds.extend(destination.geometry.location);
            map.fitBounds(bounds);
          });
        } else {
          console.error('Route calculation failed:', status);
          alert("Could not calculate route. Please ensure the selected locations are reachable by road.");
        }
      });
    }

    function getAvailableTransportModes(route) {
      const distanceMeters = route.legs[0].distance.value;
      const distanceKm = distanceMeters / 1000;
      const steps = route.legs[0].steps;
      
      //initialize available transpo
      const modes = {
        1: { available: false, name: "Airconditioned Bus", reason: "", routes: [] },
        2: { available: false, name: "Ordinary Bus", reason: "", routes: [] },
        3: { available: false, name: "Modern E-Jeepney", reason: "", routes: [] },
        4: { available: false, name: "Traditional Jeepney", reason: "", routes: [] }
      };

      let hasHighway = false;
      let hasTrunkRoad = false;
      let hasNarrowRoad = false;
      let maxSpeed = 0;

      const placesService = new google.maps.places.PlacesService(map);

      //create bounds for the route
      const routeBounds = new google.maps.LatLngBounds();
      steps.forEach(step => {
        routeBounds.extend(step.start_location);
        routeBounds.extend(step.end_location);
      });

      //check for road types
      steps.forEach(step => {
        const instructions = step.instructions.toLowerCase();
        if (instructions.includes('expressway') || 
            instructions.includes('highway') || 
            instructions.includes('motorway')) {
          hasHighway = true;
        }

        //check road types for jeep
        if (instructions.includes('trunk') || instructions.includes('primary')) {
          hasTrunkRoad = true;
        }
        if (instructions.includes('residential') || instructions.includes('secondary')) {
          hasNarrowRoad = true;
        }

        //check max speed
        if (step.duration && step.distance) {
          const stepSpeed = (step.distance.value / step.duration.value) * 3.6; // Convert to km/h
          maxSpeed = Math.max(maxSpeed, stepSpeed);
        }
      });

      //search transpo stop like bus stop or toda
      const searchPromises = [
        new Promise((resolve) => {
          placesService.nearbySearch({
            bounds: routeBounds,
            type: 'bus_station'
          }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              resolve({ type: 'bus_station', found: true });
            } else {
              resolve({ type: 'bus_station', found: false });
            }
          });
        }),
        new Promise((resolve) => {
          placesService.nearbySearch({
            bounds: routeBounds,
            keyword: 'jeepney stop'
          }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              resolve({ type: 'jeepney_stop', found: true });
            } else {
              resolve({ type: 'jeepney_stop', found: false });
            }
          });
        })
      ];

      return Promise.all(searchPromises).then(infrastructureResults => {
        const hasBusStops = infrastructureResults.find(r => r.type === 'bus_station')?.found;
        const hasJeepneyStops = infrastructureResults.find(r => r.type === 'jeepney_stop')?.found;

        //apply rules based on collected data
        if (hasHighway) {
          //only buses on highways
          modes[1].available = true;
          modes[2].available = true;
          modes[3].reason = "E-Jeepneys not allowed on expressways";
          modes[4].reason = "Traditional Jeepneys not allowed on expressways";
        } else if (distanceKm > 50) {
          //long distance routes
          if (hasBusStops) {
            modes[1].available = true;
            modes[2].available = true;
          }
          modes[3].reason = "Route too long for E-Jeepney service";
          modes[4].reason = "Route too long for Traditional Jeepney service";
        } else if (distanceKm > 15) {
          //medium distance routes
          if (hasBusStops) {
            modes[1].available = true;
            modes[2].available = true;
          }
          if (hasTrunkRoad && !hasNarrowRoad) {
            modes[3].available = true;
          }
          modes[4].reason = "Distance exceeds typical jeepney route";
        } else {
          //short distance routes
          if (hasBusStops) {
            modes[1].available = true;
            modes[2].available = true;
          }
          if (hasJeepneyStops || hasNarrowRoad) {
            modes[3].available = true;
            modes[4].available = true;
          }
          //if no specific stops found but route is suitable
          if (!hasBusStops && !hasJeepneyStops && !hasHighway) {
            modes[1].available = true;
            modes[2].available = true;
            modes[3].available = true;
            modes[4].available = true;
          }
        }

        //additional checks based on speed and road type
        if (maxSpeed > 80) { //high-speed routes
          modes[3].available = false;
          modes[4].available = false;
          modes[3].reason = modes[3].reason || "Route contains high-speed sections";
          modes[4].reason = modes[4].reason || "Route contains high-speed sections";
        }

        return modes;
      });
    }

    function updateVehicleOptions(availableModes) {
      const vehicleSelect = document.getElementById("vehicle");
      const vehicleInfo = document.getElementById("vehicleInfo");
      const currentValue = vehicleSelect.value;
      
      const vehicleGroups = {
        bus: {
          label: "Bus Services",
          options: [
            { value: "1", mode: availableModes[1] },
            { value: "2", mode: availableModes[2] }
          ]
        },
        jeepney: {
          label: "Jeepney Services",
          options: [
            { value: "3", mode: availableModes[3] },
            { value: "4", mode: availableModes[4] }
          ]
        }
      };
      
      //clear existing options
      vehicleSelect.innerHTML = '';
      
      Object.values(vehicleGroups).forEach(group => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = group.label;
        
        group.options.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option.value;
          opt.text = option.mode.name;
          
          if (!option.mode.available) {
            opt.disabled = true;
            opt.title = option.mode.reason;
            opt.style.color = '#999';
            opt.text += ' (Not Available)';
          }
          
          optgroup.appendChild(opt);
        });
        
        vehicleSelect.appendChild(optgroup);
      });

      //keep the previously selected value if it's still available
      if (availableModes[currentValue]?.available) {
        vehicleSelect.value = currentValue;
      } else {
        const firstAvailable = Object.values(availableModes).find(mode => mode.available);
        if (firstAvailable) {
          const option = Array.from(vehicleSelect.options).find(opt => !opt.disabled);
          if (option) vehicleSelect.value = option.value;
        }
      }

      const selectedMode = availableModes[vehicleSelect.value];
      if (selectedMode) {
        if (selectedMode.available) {
          vehicleInfo.className = 'vehicle-indicator available';
          vehicleInfo.innerHTML = `<span>âœ“ ${selectedMode.name} is available for this route</span>`;
        } else {
          vehicleInfo.className = 'vehicle-indicator unavailable';
          vehicleInfo.innerHTML = `<span>âœ— ${selectedMode.name} - ${selectedMode.reason}</span>`;
        }
      }

      //ewan ko basta inadd ni ai
      vehicleSelect.addEventListener('change', function() {
        const selectedMode = availableModes[this.value];
        if (selectedMode) {
          if (selectedMode.available) {
            vehicleInfo.className = 'vehicle-indicator available';
            vehicleInfo.innerHTML = `<span>âœ“ ${selectedMode.name} is available for this route</span>`;
          } else {
            vehicleInfo.className = 'vehicle-indicator unavailable';
            vehicleInfo.innerHTML = `<span>âœ— ${selectedMode.name} - ${selectedMode.reason}</span>`;
          }
        }
      });
    }

    function calculateFare(distanceTraveled, vehicleChoice, isDiscounted) {
      const DiscountRate = 0.20;

      let baseFare = 0;
      let baseDistance = 0;
      let perKmRate = 0;
      let vehicleName = "";

      switch (vehicleChoice) {
        case 1:
          vehicleName = "Airconditioned Bus";
          baseFare = 15;
          baseDistance = 5;
          perKmRate = 3;
          break;
        case 2:
          vehicleName = "Ordinary Bus";
          baseFare = 13;
          baseDistance = 5;
          perKmRate = 3;
          break;
        case 3:
          vehicleName = "Modern E-Jeepney";
          baseFare = 15;
          baseDistance = 4;
          perKmRate = 3;
          break;
        case 4:
          vehicleName = "Traditional Jeepney";
          baseFare = 13;
          baseDistance = 4;
          perKmRate = 2;
          break;
        default:
          return { error: "Invalid vehicle type" };
      }

      let regularFare = baseFare;

      if (distanceTraveled > baseDistance) {
        const extraKm = Math.floor(distanceTraveled - baseDistance);
        regularFare += extraKm * perKmRate;
      }

      const discountAmount = isDiscounted ? Math.round(regularFare * DiscountRate) : 0;
      const totalFare = Math.round(regularFare) - discountAmount;

      return {
        vehicleName,
        regularFare: Math.round(regularFare),
        discountAmount,
        totalFare
      };
    }

    function displayFare(distance, fareInfo, duration, availableModes) {
      if (fareInfo.error) {
        document.getElementById("fareSummary").innerHTML = `<p>${fareInfo.error}</p>`;
        return;
      }

      let unavailableModesList = Object.values(availableModes)
        .filter(mode => !mode.available)
        .map(mode => `<li>${mode.name} - ${mode.reason}</li>`)
        .join('');

      let transportationNotice = unavailableModesList ? 
        `<div style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border-radius: 5px;">
          <p><strong>Note:</strong> The following modes are not available for this route:</p>
          <ul style="margin-top: 5px; margin-left: 20px;">
            ${unavailableModesList}
          </ul>
        </div>` : '';

      document.getElementById("fareSummary").innerHTML = `
        <h3>Fare Summary</h3>
        <p><strong>Vehicle Type:</strong> ${fareInfo.vehicleName}</p>
        <p><strong>Distance:</strong> ${distance.toFixed(2)} km</p>
        <p><strong>Estimated Travel Time:</strong> ${duration}</p>
        <p><strong>Regular Fare:</strong> â‚±${fareInfo.regularFare.toFixed(2)}</p>
        <p><strong>Discount Applied:</strong> â‚±${fareInfo.discountAmount.toFixed(2)}</p>
        <div class="total-fare">
          <p><strong>Total Fare:</strong> <strong>â‚±${fareInfo.totalFare.toFixed(2)}</strong></p>
        </div>
        ${transportationNotice}
      `;
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJWH0VLI60CGZNcXQQbFWrLUDIfG3z3G0&libraries=places&callback=initMap">
  </script>
</body>
</html> 