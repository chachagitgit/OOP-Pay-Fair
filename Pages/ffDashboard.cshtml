@page
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@{
    var userLoggedIn = HttpContextAccessor.HttpContext?.Session.GetInt32("UserId") != null;
}
@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/ffDashboard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,900&display=swap" rel="stylesheet">
    <style>
        .input-wrapper { position: relative; }
        .main-input {
            max-width: calc(100% - 40px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 40px;
        }
        .dropdown-btn {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            background: transparent;
            border: none;
            z-index: 2;
        }
        .custom-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .place-details {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .place-details h3 { margin: 0 0 8px 0; font-size: 16px; font-weight: 500; line-height: 1.4; }
        .place-details p { margin: 5px 0; font-size: 13px; color: #5f6368; line-height: 1.4; }
        .popup-buttons { display: flex; justify-content: space-between; margin-top: 15px; }
        .popup-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        .origin-btn {
            background-color: #4CAF50;
            color: white;
        }
        .destination-btn {
            background-color: #f44336;
            color: white;
        }
        .cancel-btn {
            background-color: #9e9e9e;
            color: white;
        }
        #clearLocationsBtn {
            background-color: #1976d2;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 18px;
            font-size: 15px;
            font-family: "Poppins", sans-serif;
            font-weight: 600;
            margin: 10px 0;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(10,36,99,0.08);
            transition: background 0.2s, color 0.2s;
        }
        #clearLocationsBtn:hover {
            background-color: #0d47a1;
        }
    </style>
}
<!-- Hidden inputs for UI control -->
<input type="checkbox" id="check">
<input type="radio" name="tab" id="tab-route" checked>
<input type="radio" name="tab" id="tab-fare">

<input type="radio" name="vehicle" id="jeepney" class="vehicle-radio">
<input type="radio" name="vehicle" id="ordinary-bus" class="vehicle-radio">
<input type="radio" name="vehicle" id="aircon-bus" class="vehicle-radio">

<label for="check">
    <i class="fas fa-bars" id="btn"></i>
    <i class="fas fa-times" id="cancel"></i>
</label>

<div class="container">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/index">
            <img src="/images/logo.png" alt="PayFair Logo" class="sidebar-logo">
            </a> 
        </div>
        <div class="sidebar-content">
            <div class="tabs-container">
                <div class="tabs">
                    <label for="tab-route" class="tab_btn">Route</label>
                    <label for="tab-fare" class="tab_btn">Fare</label>
                </div>
            </div>
            <div class="content-container">
                <div class="content_box route-content">
                    <label class="location-label">Enter Starting location</label>
                    <div class="input-group">
                        <!-- Origin -->
                        <div class="input-container">
                            <input type="checkbox" id="dropdown1" class="dropdown-control">
                            <div class="input-wrapper">
                                <div class="dropdown-overlay"></div>
                                <i class="fas fa-map-marker-alt location-icon"></i>
                                <input type="text" id="originInput" class="main-input" placeholder="Starting location" aria-label="Starting location" autocomplete="off">
                                <label for="dropdown1" class="dropdown-btn"><i class="fas fa-chevron-down"></i></label>
                                <div class="dropdown-menu" id="originDropdown"></div>
                            </div>
                        </div>
                        <!-- Destination -->
                        <label class="location-label">Enter Destination</label>
                        <div class="input-container">
                            <input type="checkbox" id="dropdown2" class="dropdown-control">
                            <div class="input-wrapper">
                                <div class="dropdown-overlay"></div>
                                <i class="fas fa-map-marker-alt location-icon"></i>
                                <input type="text" id="destinationInput" class="main-input" placeholder="Destination" aria-label="Destination" autocomplete="off">
                                <label for="dropdown2" class="dropdown-btn"><i class="fas fa-chevron-down"></i></label>
                                <div class="dropdown-menu" id="destinationDropdown"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Clear Locations button -->
                    <button type="button" id="clearLocationsBtn" class="popup-button origin-btn">Clear Locations</button>
                    <div class="section-title">Transportation Options</div>
                    <div class="vehicle-options">
                        <input type="radio" id="vehicle1" name="vehicle" class="vehicle-radio" value="4">
                        <label for="vehicle1" class="vehicle-btn">Traditional Jeepney<i class="fas fa-bus-alt vehicle-icon"></i></label>
                        <input type="radio" id="vehicle2" name="vehicle" class="vehicle-radio" value="1">
                        <label for="vehicle2" class="vehicle-btn">Airconditioned Bus<i class="fas fa-bus-alt vehicle-icon"></i></label>
                        <input type="radio" id="vehicle3" name="vehicle" class="vehicle-radio" value="2">
                        <label for="vehicle3" class="vehicle-btn">Ordinary Bus<i class="fas fa-bus-alt vehicle-icon"></i></label>
                        <input type="radio" id="vehicle4" name="vehicle" class="vehicle-radio" value="3">
                        <label for="vehicle4" class="vehicle-btn">Modern E-Jeepney<i class="fas fa-bus-alt vehicle-icon"></i></label>
                    </div>
                    <div class="section-title">Discount</div>
                    <div class="discount">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="discounts" name="discounts" value="Student/PWD/Senior Citizen">
                            <label for="discounts">Student/PWD/Senior Citizen</label>
                        </div>
                    </div>
                    <button class="calculate-fare" onclick="calculateRoute()">Calculate Fare</button>
                </div>
                <div class="content_box fare-content">
                    <div class="fare-card">
                        <div class="header-section"></div>
                        <div class="content-section">
                            <div class="total-fare">
                                <h2>Total estimated fare:</h2>
                                <div class="fare-amount" id="fareAmount">â‚± XXXX</div>
                            </div>
                            <div class="section">
                                <div class="section-title">Location</div>
                                <div id="fareLocation"></div>
                            </div>
                            <div class="section">
                                <div class="section-title">Breakdown</div>
                                <div class="breakdown-item">
                                    <span class="item-label">Vehicle</span>
                                    <span class="item-value" id="vehicle-options">XXXX</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="item-label">Regular fare</span>
                                    <span class="item-value" id="baseFare">XXXX</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="item-label">Applied discount</span>
                                    <span class="item-value" id="appliedDiscount">XXXX</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="item-label">Distance</span>
                                    <span class="item-value" id="distance">XXXX</span>
                                </div>
                                <div class="breakdown-item total">
                                    <span class="item-label">Total estimated fare</span>
                                    <span class="item-value" id="totalFare">XXXX</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="save-route">Save Route</button>
                </div>
            </div>
        </div>
    </div>
    <div id="map" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;"></div>
</div>
    <div class="notification-dialog" id="saveRouteNotification">
        <div class="notification-content">
            <i class="fas fa-check-circle notification-icon"></i>
            <p class="notification-message">Route saved successfully!</p>
            <button class="notification-close-btn">OK</button>
        </div>
    </div>
<script>
    // Save Route Button with Notification
    document.querySelector('.save-route').addEventListener('click', function() {
        // Show notification
        const notification = document.getElementById('saveRouteNotification');
        notification.classList.add('active');
        
        // Close notification after 3 seconds automatically
        setTimeout(() => {
            notification.classList.remove('active');
        }, 3000);
    });

    // Close notification when OK button is clicked
    document.querySelector('.notification-close-btn').addEventListener('click', function() {
        document.getElementById('saveRouteNotification').classList.remove('active');
    });

    // Close notification when clicking outside
    document.getElementById('saveRouteNotification').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
    let lastFareInfo = null;
    let lastOrigin = null;
    let lastDestination = null;
    
    const saveRouteBtn = document.querySelector('.save-route');
    saveRouteBtn.disabled = true;
    
    function enableSaveRouteIfReady() {
        saveRouteBtn.disabled = !(userLoggedIn && lastFareInfo && lastOrigin && lastDestination);
    }
    
    // Hook into displayFare to store last fare and enable button
    const originalDisplayFare = window.displayFare;
    window.displayFare = function(distance, fareInfo, duration, originName, destinationName) {
        lastFareInfo = fareInfo;
        lastOrigin = originName;
        lastDestination = destinationName;
        enableSaveRouteIfReady();
        if (originalDisplayFare) originalDisplayFare(distance, fareInfo, duration, originName, destinationName);
    };
    
    saveRouteBtn.addEventListener('click', function() {
        if (!userLoggedIn) {
            alert('You must be logged in to save routes.');
            return;
        }
        if (!lastFareInfo || !lastOrigin || !lastDestination) {
            alert('Please calculate a fare first.');
            return;
        }
        fetch(window.location.pathname + '?handler=SaveRoute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                Origin: lastOrigin,
                Destination: lastDestination,
                Fare: lastFareInfo.totalFare
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const notification = document.getElementById('saveRouteNotification');
                notification.classList.add('active');
                setTimeout(() => { notification.classList.remove('active'); }, 3000);
            } else {
                alert(data.error || 'Failed to save route.');
            }
        })
        .catch(() => alert('Failed to save route.'));
    });
</script>

<div id="locationPopup" class="custom-popup">
    <div class="place-details">
        <h3 id="popup-place-name">Place Name</h3>
        <p id="popup-place-address">Address</p>
        <p id="popup-place-coords">Coordinates</p>
    </div>
    <div class="popup-buttons">
        <button class="popup-button origin-btn" id="setOrigin">Set as Origin</button>
        <button class="popup-button destination-btn" id="setDestination">Set as Destination</button>
        <button class="popup-button cancel-btn" id="cancelSelection">Cancel</button>
    </div>
</div>

<footer class="app-footer"> 
    <p>CopyrightÂ© 2025 PayFair Â· All rights reserved
        <span class="footer-nav">
            <a href="~/index#aboutSection">About Us |</a>
            <a href="~/index#termsSection">Terms and Conditions |</a>
            <a href="~/index#privacySection">Privacy Policy |</a>
            <a href="~/index#contactSection">Contact Us</a>
        </span> 
    </p>
</footer>

@section Scripts {
    <script>
        let map, directionsService, directionsRenderer, trafficLayer;
        let originAutocomplete, destinationAutocomplete;
        function initMap() {
            // Metro Manila boundaries
            const metroManilaBounds = {
                north: 14.8527,
                south: 14.3475,
                west: 120.8936,
                east: 121.1979
            };

            const manila = { lat: 14.5995, lng: 120.9842 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: manila,
                mapTypeControl: false,
                restriction: {
                    latLngBounds: metroManilaBounds,
                    strictBounds: true
                },
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            // Add real-time traffic layer
            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: "#3498db",
                    strokeWeight: 5
                }
            });
            directionsRenderer.setMap(map);

            // Metro Manila bounds for autocomplete
            const defaultBounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(14.3475, 120.8936),
                new google.maps.LatLng(14.8527, 121.1979)
            );

            const autocompleteOptions = {
                bounds: defaultBounds,
                componentRestrictions: { country: "ph" },
                fields: ["geometry", "name", "formatted_address"],
                strictBounds: true
            };

            originAutocomplete = new google.maps.places.Autocomplete(
                document.getElementById("originInput"),
                autocompleteOptions
            );

            destinationAutocomplete = new google.maps.places.Autocomplete(
                document.getElementById("destinationInput"),
                autocompleteOptions
            );

            // Add input event listeners to reset manual selection state
            document.getElementById('originInput').addEventListener('input', function(e) {
                if (e.target.value === '') {
                    if (originAutocomplete._originalGetPlace) {
                        originAutocomplete.getPlace = originAutocomplete._originalGetPlace;
                        delete originAutocomplete._manualPlace;
                        delete originAutocomplete._hasManualSelection;
                        delete originAutocomplete._originalGetPlace;
                    }
                    if (window.originMarker) {
                        window.originMarker.setMap(null);
                    }
                }
            });

            document.getElementById('destinationInput').addEventListener('input', function(e) {
                if (e.target.value === '') {
                    if (destinationAutocomplete._originalGetPlace) {
                        destinationAutocomplete.getPlace = destinationAutocomplete._originalGetPlace;
                        delete destinationAutocomplete._manualPlace;
                        delete destinationAutocomplete._hasManualSelection;
                        delete destinationAutocomplete._originalGetPlace;
                    }
                    if (window.destMarker) {
                        window.destMarker.setMap(null);
                    }
                }
            });

            originAutocomplete.addListener("place_changed", validatePlace);
            destinationAutocomplete.addListener("place_changed", validatePlace);

            // Clear Locations button logic
            document.getElementById('clearLocationsBtn').onclick = function() {
                document.getElementById("originInput").value = "";
                document.getElementById("destinationInput").value = "";
                if (window.originMarker) window.originMarker.setMap(null);
                if (window.destMarker) window.destMarker.setMap(null);
                if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
                document.getElementById("fareAmount").innerText = "â‚± XXXX";
                document.getElementById("baseFare").innerText = "XXXX";
                document.getElementById("appliedDiscount").innerText = "XXXX";
                document.getElementById("distance").innerText = "XXXX";
                document.getElementById("totalFare").innerText = "XXXX";
                document.getElementById("fareLocation").innerText = "";
            };

            map.addListener('click', function(event) {
                const latLng = event.latLng;
                const lat = latLng.lat();
                const lng = latLng.lng();
                const bounds = {
                    north: 14.8527,
                    south: 14.3475,
                    west: 120.8936,
                    east: 121.1979
                };

                if (lat < bounds.south || lat > bounds.north || lng < bounds.west || lng > bounds.east) {
                    alert("Please select a location within Metro Manila only.");
                    return;
                }

                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: latLng }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        const place = results[0];
                        document.getElementById('popup-place-name').textContent = 
                            place.address_components[0].long_name || 'Selected Location';
                        document.getElementById('popup-place-address').textContent = 
                            place.formatted_address;
                        document.getElementById('popup-place-coords').textContent = 
                            `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        const popup = document.getElementById('locationPopup');
                        popup.style.display = 'block';
                        document.getElementById('setOrigin').onclick = function() {
                            setLocationInput('originInput', latLng, 'Origin');
                            popup.style.display = 'none';
                        };
                        document.getElementById('setDestination').onclick = function() {
                            setLocationInput('destinationInput', latLng, 'Destination');
                            popup.style.display = 'none';
                        };
                        document.getElementById('cancelSelection').onclick = function() {
                            popup.style.display = 'none';
                        };
                    } else {
                        alert('Could not determine address for this location.');
                    }
                });
            });
        }

        function setLocationInput(inputId, latLng, label) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: latLng }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    // Automatically use the first result without showing dropdown
                    const firstResult = results[0];
                    const address = firstResult.formatted_address;

                    // Create a place object from the first result
                    const placeObj = {
                        name: address,
                        formatted_address: address,
                        geometry: { 
                            location: new google.maps.LatLng(latLng.lat(), latLng.lng())
                        },
                        place_id: firstResult.place_id || 'manual_' + Date.now()
                    };

                    // Update the input field
                    const inputElem = document.getElementById(inputId);
                    inputElem.value = address;

                    // Get the correct autocomplete object
                    const ac = (inputId === 'originInput') ? originAutocomplete : destinationAutocomplete;
                    
                    // Store the manual place and set selection flag
                    ac._manualPlace = placeObj;
                    ac._hasManualSelection = true;

                    // Place marker
                    const markerOptions = {
                        position: latLng,
                        map: map,
                        title: label,
                        icon: {
                            url: inputId === 'originInput' ? 
                                'http://maps.google.com/mapfiles/ms/icons/green-dot.png' : 
                                'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                            scaledSize: new google.maps.Size(40, 40)
                        },
                        animation: google.maps.Animation.DROP
                    };

                    if (inputId === 'originInput') {
                        if (window.originMarker) window.originMarker.setMap(null);
                        window.originMarker = new google.maps.Marker(markerOptions);
                    } else {
                        if (window.destMarker) window.destMarker.setMap(null);
                        window.destMarker = new google.maps.Marker(markerOptions);
                    }

                    // --- NEW: Auto-calculate if both are set and vehicle is selected ---
                    const originVal = document.getElementById("originInput").value;
                    const destVal = document.getElementById("destinationInput").value;
                    const vehicleSelected = document.querySelector('input[name="vehicle"]:checked');
                    if (originVal && destVal && vehicleSelected) {
                        calculateRoute();
                    }
                    // ---------------------------------------------------------------
                } else {
                    console.error('Geocoding failed:', status);
                    alert('Could not determine address for this location.');
                }
            });
        }

        function validatePlace() {
            this._hasManualSelection = false;
            if (this._originalGetPlace) {
                this.getPlace = this._originalGetPlace;
                delete this._manualPlace;
                delete this._originalGetPlace;
            }

            const place = this.getPlace();
            if (!place || !place.geometry) {
                alert("Please select a location from the dropdown list or click on the map.");
                resetForm();
                return false;
            }

            const lat = place.geometry.location.lat();
            const lng = place.geometry.location.lng();

            const bounds = {
                north: 14.8527,
                south: 14.3475,
                west: 120.8936,
                east: 121.1979
            };

            if (lat < bounds.south || lat > bounds.north || lng < bounds.west || lng > bounds.east) {
                alert("Please select a location within Metro Manila only.");
                resetForm();
                return false;
            }

            return true;
        }

        function resetForm() {
            document.getElementById("originInput").value = "";
            document.getElementById("destinationInput").value = "";

            if (originAutocomplete._originalGetPlace) {
                originAutocomplete.getPlace = originAutocomplete._originalGetPlace;
                delete originAutocomplete._manualPlace;
                delete originAutocomplete._hasManualSelection;
                delete originAutocomplete._originalGetPlace;
            }
            
            if (destinationAutocomplete._originalGetPlace) {
                destinationAutocomplete.getPlace = destinationAutocomplete._originalGetPlace;
                delete destinationAutocomplete._manualPlace;
                delete destinationAutocomplete._hasManualSelection;
                delete destinationAutocomplete._originalGetPlace;
            }

            const vehicleRadios = document.querySelectorAll('input[name="vehicle"]');
            vehicleRadios.forEach(radio => radio.checked = false);

            document.getElementById("discounts").checked = false;

            document.getElementById("fareAmount").innerText = "â‚± XXXX";
            document.getElementById("baseFare").innerText = "XXXX";
            document.getElementById("appliedDiscount").innerText = "XXXX";
            document.getElementById("distance").innerText = "XXXX";
            document.getElementById("totalFare").innerText = "XXXX";
            document.getElementById("fareLocation").innerText = "";

            if (window.originMarker) {
                window.originMarker.setMap(null);
            }
            if (window.destMarker) {
                window.destMarker.setMap(null);
            }
            if (directionsRenderer) {
                directionsRenderer.setDirections({ routes: [] });
            }

            document.getElementById("tab-route").checked = true;
        }

        function calculateRoute() {
            let origin = originAutocomplete.getPlace();
            let destination = destinationAutocomplete.getPlace();

            if (originAutocomplete._hasManualSelection && originAutocomplete._manualPlace) {
                origin = originAutocomplete._manualPlace;
            }

            if (destinationAutocomplete._hasManualSelection && destinationAutocomplete._manualPlace) {
                destination = destinationAutocomplete._manualPlace;
            }

            if (!origin || !origin.geometry || !origin.geometry.location) {
                alert("Please select a valid origin from the dropdown list or by clicking on the map.");
                return;
            }
            
            if (!destination || !destination.geometry || !destination.geometry.location) {
                alert("Please select a valid destination from the dropdown list or by clicking on the map.");
                return;
            }

            if (!(origin.geometry.location instanceof google.maps.LatLng)) {
                origin.geometry.location = new google.maps.LatLng(
                    origin.geometry.location.lat(),
                    origin.geometry.location.lng()
                );
            }
            if (!(destination.geometry.location instanceof google.maps.LatLng)) {
                destination.geometry.location = new google.maps.LatLng(
                    destination.geometry.location.lat(),
                    destination.geometry.location.lng()
                );
            }

            const originLat = origin.geometry.location.lat();
            const originLng = origin.geometry.location.lng();
            const destLat = destination.geometry.location.lat();
            const destLng = destination.geometry.location.lng();

            const bounds = {
                north: 14.8527,
                south: 14.3475,
                west: 120.8936,
                east: 121.1979
            };

            if (originLat < bounds.south || originLat > bounds.north || 
                originLng < bounds.west || originLng > bounds.east) {
                alert("Origin must be within Metro Manila.");
                return;
            }

            if (destLat < bounds.south || destLat > bounds.north || 
                destLng < bounds.west || destLng > bounds.east) {
                alert("Destination must be within Metro Manila.");
                return;
            }

            if (!document.querySelector('input[name="vehicle"]:checked')) {
                alert("Please select a vehicle type.");
                return;
            }

            if (window.originMarker) window.originMarker.setMap(null);
            if (window.destMarker) window.destMarker.setMap(null);
            
            window.originMarker = new google.maps.Marker({
                position: origin.geometry.location,
                map: map,
                title: origin.name || origin.formatted_address,
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                },
                animation: google.maps.Animation.DROP
            });
            
            window.destMarker = new google.maps.Marker({
                position: destination.geometry.location,
                map: map,
                title: destination.name || destination.formatted_address,
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                },
                animation: google.maps.Animation.DROP
            });

            const request = {
                origin: origin.geometry.location,
                destination: destination.geometry.location,
                travelMode: google.maps.TravelMode.DRIVING,
                optimizeWaypoints: true
            };

            directionsService.route(request, function(result, status) {
                if (status === "OK") {
                    directionsRenderer.setDirections(result);
                    const route = result.routes[0];
                    const distanceMeters = route.legs[0].distance.value;
                    const distanceKm = distanceMeters / 1000;
                    const duration = route.legs[0].duration.text;
                    const vehicleChoice = parseInt(document.querySelector('input[name="vehicle"]:checked')?.value || '4');
                    const isDiscounted = document.getElementById("discounts").checked;

                    calculateFare(distanceKm, vehicleChoice, isDiscounted)
                        .then(fareInfo => {
                            if (fareInfo.error) {
                                alert('Error calculating fare: ' + fareInfo.error);
                                return;
                            }
                            displayFare(distanceKm, fareInfo, duration, 
                                      origin.name || origin.formatted_address, 
                                      destination.name || destination.formatted_address);
                            document.getElementById('tab-fare').checked = true;
                        })
                        .catch(error => {
                            alert('Error calculating fare. Please try again.');
                        });

                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(origin.geometry.location);
                    bounds.extend(destination.geometry.location);
                    map.fitBounds(bounds);
                } else {
                    alert("Could not calculate route. Please ensure the selected locations are reachable by road.");
                }
            }); 
        }
        function calculateFare(distanceTraveled, vehicleChoice, isDiscounted) {
            const request = {
                distanceTraveled: distanceTraveled,
                vehicleChoice: vehicleChoice,
                isDiscounted: isDiscounted
            };
            return fetch('/api/fare/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(request)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Failed to calculate fare: ${text}`);
                    });
                }
                return response.json();
            })
            .catch(error => {
                return { error: error.message || "Failed to calculate fare" };
            });
        }
        function displayFare(distance, fareInfo, duration, originName, destinationName) {
            if (fareInfo.error) {
                document.getElementById("fareAmount").innerText = "Error";
                return;
            }
            // Vehicle mapping based on the values in your HTML
            const vehicleMapping = {
                '4': 'Traditional Jeepney',
                '1': 'Airconditioned Bus', 
                '2': 'Ordinary Bus',
                '3': 'Modern E-Jeepney'
            };
             // Get the selected vehicle type
            const selectedVehicle = document.querySelector('input[name="vehicle"]:checked');
            const vehicleText = selectedVehicle ? vehicleMapping[selectedVehicle.value] || 'Unknown' : 'Unknown';
    
            document.getElementById("fareAmount").innerText = `â‚± ${fareInfo.totalFare.toFixed(2)}`;
            document.getElementById("baseFare").innerText = `â‚± ${fareInfo.baseFare.toFixed(2)}`;
            document.getElementById("appliedDiscount").innerText = `â‚± ${fareInfo.discountAmount.toFixed(2)}`;
            document.getElementById("distance").innerText = `${distance.toFixed(2)} km`;
            document.getElementById("totalFare").innerText = `â‚± ${fareInfo.totalFare.toFixed(2)}`;
            document.getElementById("fareLocation").innerText = `${originName} â†’ ${destinationName}`;
            document.getElementById("vehicle-options").innerText = vehicleText;
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJWH0VLI60CGZNcXQQbFWrLUDIfG3z3G0&libraries=places&callback=initMap"></script>
}