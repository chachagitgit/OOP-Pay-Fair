<!DOCTYPE html>
<html>
<head>
  <title>PayFair</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      padding: 20px;
      background-color: #f5f5f5;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
      font-size: 2em;
    }

    .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: #3498db;
    }

    .discount-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 6px;
    }

    .discount-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    button {
      width: 100%;
      padding: 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #2980b9;
    }

    #map {
      height: 400px;
      width: 100%;
      margin: 20px 0;
      border-radius: 10px;
      border: 1px solid #ddd;
    }

    #fareSummary {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    #fareSummary h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }

    #fareSummary p {
      margin: 10px 0;
      color: #34495e;
      line-height: 1.5;
    }

    .total-fare {
      font-size: 1.2em;
      color: #2c3e50;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px dashed #ddd;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .input-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>PayFair</h2>
    
    <div class="input-group">
      <input 
        list="originList" 
        id="originInput" 
        placeholder="Search Origin"
        autocomplete="off">
      <datalist id="originList"></datalist>

      <input 
        list="destinationList" 
        id="destinationInput" 
        placeholder="Search Destination"
        autocomplete="off">
      <datalist id="destinationList"></datalist>

      <select id="vehicle">
        <option value="1">Airconditioned Bus</option>
        <option value="2">Ordinary Bus</option>
        <option value="3">Modern E-Jeepney</option>
        <option value="4">Traditional Jeepney</option>
      </select>

      <div class="discount-group">
        <label>
          <input type="checkbox" id="discount">
          <span>Discounted Rate (Student/Senior/PWD)</span>
        </label>
      </div>

      <button onclick="calculateRoute()">Calculate Fare</button>
    </div>

    <div id="map"></div>
    <div id="fareSummary"></div>
  </div>

  <script>
    let map, directionsService, directionsRenderer;
    let stops = [];

    function initMap() {
      const manila = { lat: 14.5995, lng: 120.9842 };
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: manila,
        styles: [
          {
            featureType: "poi",
            elementType: "labels",
            stylers: [{ visibility: "off" }]
          }
        ]
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
          strokeColor: "#3498db",
          strokeWeight: 5
        }
      });
      directionsRenderer.setMap(map);

      fetchStops();
    }

    function fetchStops() {
      fetch('stops.txt')
        .then(response => response.text())
        .then(data => {
          const lines = data.trim().split('\n');
          stops = []; 

          const headerLine = lines[0].replace(/"/g, '');
          const headers = headerLine.split(',');
          const latIndex = headers.indexOf('stop_lat');
          const lonIndex = headers.indexOf('stop_lon');
          const nameIndex = headers.indexOf('stop_name');
          const idIndex = headers.indexOf('stop_id');

          console.log('Total lines in stops.txt:', lines.length);
          console.log('Column indices:', { latIndex, lonIndex, nameIndex, idIndex });

          for (let i = 1; i < lines.length; i++) {
            try {
              let values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
              
              const id = values[idIndex];
              const name = values[nameIndex];
              const lat = values[latIndex];
              const lon = values[lonIndex];

              const parsedLat = parseFloat(lat);
              const parsedLon = parseFloat(lon);

              if (!isNaN(parsedLat) && !isNaN(parsedLon) && name) {
                stops.push({
                  stop_id: id,
                  stop_name: name,
                  lat: parsedLat,
                  lon: parsedLon
                });
              } else {
                console.warn('Skipped invalid stop:', {
                  line: i + 1,
                  name,
                  lat: parsedLat,
                  lon: parsedLon
                });
              }
            } catch (err) {
              console.error('Error parsing line', i + 1, err);
            }
          }

          stops.sort((a, b) => a.stop_name.localeCompare(b.stop_name));
          
          console.log('Total stops loaded:', stops.length);
          populateStopLists();

          console.log('Sample stops:', stops.slice(0, 5));
        })
        .catch(err => {
          console.error("Failed to load stops.txt", err);
          alert("Error loading stops data. Please try again later.");
        });
    }

    function populateStopLists() {
      const originList = document.getElementById("originList");
      const destinationList = document.getElementById("destinationList");

      stops.forEach(stop => {
        const opt1 = new Option(stop.stop_name, stop.stop_name);
        const opt2 = new Option(stop.stop_name, stop.stop_name);
        originList.appendChild(opt1);
        destinationList.appendChild(opt2);
      });
    }

    function calculateRoute() {
      const originName = document.getElementById("originInput").value;
      const destinationName = document.getElementById("destinationInput").value;
      const vehicleChoice = parseInt(document.getElementById("vehicle").value);
      const isDiscounted = document.getElementById("discount").checked;

      const originStop = stops.find(s => s.stop_name === originName);
      const destStop = stops.find(s => s.stop_name === destinationName);

      if (!originStop || !destStop) {
        alert("Please select valid stops from the list.");
        return;
      }

      if (window.originMarker) window.originMarker.setMap(null);
      if (window.destMarker) window.destMarker.setMap(null);

      window.originMarker = new google.maps.Marker({
        position: { lat: originStop.lat, lng: originStop.lon },
        map: map,
        title: originStop.stop_name,
        icon: {
          url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
          scaledSize: new google.maps.Size(40, 40)
        },
        animation: google.maps.Animation.DROP
      });

      window.destMarker = new google.maps.Marker({
        position: { lat: destStop.lat, lng: destStop.lon },
        map: map,
        title: destStop.stop_name,
        icon: {
          url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
          scaledSize: new google.maps.Size(40, 40)
        },
        animation: google.maps.Animation.DROP
      });

      const request = {
        origin: { lat: originStop.lat, lng: originStop.lon },
        destination: { lat: destStop.lat, lng: destStop.lon },
        travelMode: google.maps.TravelMode.DRIVING,
        optimizeWaypoints: true
      };

      console.log('Calculating route:', {
        from: originStop.stop_name,
        to: destStop.stop_name,
        originCoords: { lat: originStop.lat, lng: originStop.lon },
        destCoords: { lat: destStop.lat, lng: destStop.lon }
      });

      directionsService.route(request, function(result, status) {
        if (status === "OK") {
          directionsRenderer.setDirections(result);

          const route = result.routes[0];
          const distanceMeters = route.legs[0].distance.value;
          const distanceKm = distanceMeters / 1000;
          const duration = route.legs[0].duration.text;

          const fareInfo = calculateFare(distanceKm, vehicleChoice, isDiscounted);
          displayFare(distanceKm, fareInfo, duration);

          const bounds = new google.maps.LatLngBounds();
          bounds.extend({ lat: originStop.lat, lng: originStop.lon });
          bounds.extend({ lat: destStop.lat, lng: destStop.lon });
          map.fitBounds(bounds);
        } else {
          console.error('Route calculation failed:', status);
          alert("Could not calculate route. Please ensure the selected stops are reachable by road.");
        }
      });
    }

    function calculateFare(distanceTraveled, vehicleChoice, isDiscounted) {
      const DiscountRate = 0.20;

      let baseFare = 0;
      let baseDistance = 0;
      let perKmRate = 0;
      let vehicleName = "";

      switch (vehicleChoice) {
        case 1:
          vehicleName = "Airconditioned Bus";
          baseFare = 15;
          baseDistance = 5;
          perKmRate = 3;
          break;
        case 2:
          vehicleName = "Ordinary Bus";
          baseFare = 13;
          baseDistance = 5;
          perKmRate = 3;
          break;
        case 3:
          vehicleName = "Modern E-Jeepney";
          baseFare = 15;
          baseDistance = 4;
          perKmRate = 3;
          break;
        case 4:
          vehicleName = "Traditional Jeepney";
          baseFare = 13;
          baseDistance = 4;
          perKmRate = 2;
          break;
        default:
          return { error: "Invalid vehicle type" };
      }

      let regularFare = baseFare;

      if (distanceTraveled > baseDistance) {
        const extraKm = Math.floor(distanceTraveled - baseDistance);
        regularFare += extraKm * perKmRate;
      }

      const discountAmount = isDiscounted ? Math.round(regularFare * DiscountRate) : 0;
      const totalFare = Math.round(regularFare) - discountAmount;

      return {
        vehicleName,
        regularFare: Math.round(regularFare),
        discountAmount,
        totalFare
      };
    }

    function displayFare(distance, fareInfo, duration) {
      if (fareInfo.error) {
        document.getElementById("fareSummary").innerHTML = `<p>${fareInfo.error}</p>`;
        return;
      }

      document.getElementById("fareSummary").innerHTML = `
        <h3>Fare Summary</h3>
        <p><strong>Vehicle Type:</strong> ${fareInfo.vehicleName}</p>
        <p><strong>Distance:</strong> ${distance.toFixed(2)} km</p>
        <p><strong>Estimated Travel Time:</strong> ${duration}</p>
        <p><strong>Regular Fare:</strong> ₱${fareInfo.regularFare.toFixed(2)}</p>
        <p><strong>Discount Applied:</strong> ₱${fareInfo.discountAmount.toFixed(2)}</p>
        <div class="total-fare">
          <p><strong>Total Fare:</strong> <strong>₱${fareInfo.totalFare.toFixed(2)}</strong></p>
        </div>
      `;
    }

    //validate coordinates
    function isValidCoordinate(coord) {
      const num = Number(coord);
      return !isNaN(num) && isFinite(num);
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJWH0VLI60CGZNcXQQbFWrLUDIfG3z3G0&callback=initMap">
  </script>
</body>
</html> 